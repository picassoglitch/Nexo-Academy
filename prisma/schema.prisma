// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
}

enum IncomePath {
  PATH1 // AI Services for Local Businesses
  PATH2 // AI Content for Creators
  PATH3 // AI Digital Products
  PATH4 // AI Consulting / Freelancing
  PATH5 // SaaS / Herramientas IA
}

enum Tier {
  STARTER
  PRO
  OPERATOR
}

enum PaymentProvider {
  STRIPE // Stripe
}

enum OrderStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  IN_PROCESS
}

enum CouponType {
  PERCENT
  FIXED
}

enum ReferralStatus {
  PENDING
  PAID
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String?
  role          UserRole @default(USER)
  tier          Int      @default(0) // 0=gratis, 1=starter, 2=pro, 3=operator
  selectedPathId String? // Para starter: ID del m√≥dulo/path elegido (deprecated, usar selectedCourseId)
  selectedCourseId String? // Para starter: ID del curso elegido
  mpCustomerId  String? // Stripe customer ID (field name kept for backward compatibility)
  supabaseId    String? // Supabase Auth user ID
  // Synced from Supabase Auth
  emailConfirmed Boolean @default(false) // Synced from Supabase email_confirmed_at
  emailConfirmedAt DateTime? // When email was confirmed in Supabase
  lastSignInAt  DateTime? // Last sign-in time from Supabase
  createdAt     DateTime @default(now())

  quizResponses     QuizResponse[]
  lessonProgress    LessonProgress[]
  orders            Order[]
  entitlements      Entitlement[]
  testimonials      Testimonial[]
  referralsGiven    Referral[]       @relation("Referrer")
  referralsReceived Referral[]       @relation("Referred")
  abandonedCarts    AbandonedCart[]
  lessonViews       LessonView[]
  lessonFeedback    LessonFeedback[]
  supportTickets    SupportTicket[]
  userActivities    UserActivity[]
  pathAnalytics     PathAnalytics[]
}

model QuizResponse {
  id        String   @id @default(uuid())
  userId    String?
  payload   Json // Store all quiz answers
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan?
}

model Plan {
  id              String     @id @default(uuid())
  quizResponseId  String     @unique
  recommendedPath IncomePath
  recommendedTier Tier
  planJson        Json // Additional plan data
  createdAt       DateTime   @default(now())

  quizResponse QuizResponse @relation(fields: [quizResponseId], references: [id], onDelete: Cascade)

  @@index([quizResponseId])
}

model Course {
  id            String   @id @default(uuid())
  slug          String   @unique
  title         String
  description   String?
  published     Boolean  @default(false)
  requiredTiers Json?   // Array of tier strings: ["ALL", "STARTER", "PRO", "OPERATOR"]
  createdAt     DateTime @default(now())

  modules Module[]
}

model Module {
  id          String   @id @default(uuid())
  courseId    String
  order       Int
  title       String
  description String?
  createdAt   DateTime @default(now())

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([courseId])
}

model Lesson {
  id                String   @id @default(uuid())
  moduleId          String
  slug              String
  order             Int
  title             String
  summary           String?
  videoUrl          String?
  transcriptMd      String?
  actionChecklistMd String?
  isFreePreview     Boolean  @default(false)
  requiredTier      Tier     @default(STARTER)
  createdAt         DateTime @default(now())
  
  // New fields for advanced lesson form
  lessonType        String?  // "Texto Principal", "Video Principal", "Interactivo", "Mixto"
  estimatedDuration Int?     // minutes
  quizQuestions     String?  // JSON array of quiz questions
  assignments       String?  // Markdown instructions
  interactionPoints Int?     @default(0)
  completionPoints  Int?     @default(100)
  badgeName         String?
  badgeIcon         String?  // URL or base64
  completionMessage String?
  additionalReward  String?
  prerequisites     String?  // JSON array of lesson IDs
  tags              String?  // JSON array of tags
  status            String?  @default("Borrador") // "Borrador", "Publicada", "Archivada"
  attachments       String?  // JSON array of file attachments

  module         Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  lessonProgress LessonProgress[]
  lessonViews    LessonView[]
  lessonFeedback LessonFeedback[]
  lessonVersions LessonVersion[]
  lessonState    LessonState?
  supportTickets SupportTicket[]

  @@unique([moduleId, slug])
  @@index([moduleId])
}

model LessonProgress {
  id                  String    @id @default(uuid())
  userId              String
  lessonId            String
  completed           Boolean   @default(false)
  completedAt         DateTime?
  lastPositionSeconds Int       @default(0)
  createdAt           DateTime  @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model Asset {
  id           String   @id @default(uuid())
  title        String
  description  String?
  fileUrl      String
  category     String?
  requiredTier Tier     @default(STARTER)
  createdAt    DateTime @default(now())
}

model Order {
  id         String          @id @default(uuid())
  userId     String
  provider   PaymentProvider @default(STRIPE)
  externalId String          @unique // Stripe payment/session ID
  status     OrderStatus
  amount     Int // Amount in cents (USD)
  currency   String          @default("USD")
  couponId   String?
  createdAt  DateTime        @default(now())

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  coupon Coupon? @relation(fields: [couponId], references: [id])

  @@index([userId])
  @@index([externalId])
}

model Entitlement {
  id        String   @id @default(uuid())
  userId    String
  tier      Tier
  active    Boolean  @default(true)
  grantedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tier])
  @@index([userId])
}

model Coupon {
  id             String     @id @default(uuid())
  code           String     @unique
  type           CouponType
  amount         Int // Percentage (0-100) or fixed amount in cents
  active         Boolean    @default(true)
  maxRedemptions Int?
  redeemedCount  Int        @default(0)
  expiresAt      DateTime?
  createdAt      DateTime   @default(now())

  orders Order[]
}

model Testimonial {
  id        String   @id @default(uuid())
  userId    String?
  content   String
  videoUrl  String?
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Referral {
  id               String         @id @default(uuid())
  referrerUserId   String
  referredUserId   String
  commissionAmount Int // Amount in cents (MXN)
  status           ReferralStatus @default(PENDING)
  createdAt        DateTime       @default(now())

  referrer User @relation("Referrer", fields: [referrerUserId], references: [id], onDelete: Cascade)
  referred User @relation("Referred", fields: [referredUserId], references: [id], onDelete: Cascade)

  @@index([referrerUserId])
  @@index([referredUserId])
}

model AbandonedCart {
  id        String   @id @default(uuid())
  userId    String?
  sessionId String
  tier      Tier
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// Advanced Analytics Models
model LessonView {
  id               String   @id @default(uuid())
  userId           String
  lessonId         String
  viewedAt         DateTime @default(now())
  timeSpentSeconds Int      @default(0)
  completed        Boolean  @default(false)
  skipped          Boolean  @default(false)
  replayCount      Int      @default(0)
  dropOffTimestamp Int? // Seconds into lesson where user left
  device           String? // mobile, desktop
  createdAt        DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId, viewedAt])
  @@index([lessonId])
  @@index([userId])
  @@index([viewedAt])
}

model LessonFeedback {
  id          String   @id @default(uuid())
  userId      String
  lessonId    String
  wasClear    Boolean? // Yes/No feedback
  emojiRating Int? // 1-5 emoji rating
  confusion   String? // Free text: "What confused you?"
  createdAt   DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@index([userId])
}

model LessonVersion {
  id           String   @id @default(uuid())
  lessonId     String
  version      Int      @default(1)
  title        String
  transcriptMd String?
  videoUrl     String?
  updatedBy    String? // Admin user ID
  updatedAt    DateTime @default(now())
  changeLog    String? // What changed

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([lessonId, version])
  @@index([lessonId])
}

model LessonState {
  id          String   @id @default(uuid())
  lessonId    String   @unique
  state       String   @default("live") // draft, live, hidden, deprecated, locked
  lockedUntil String? // Lesson ID that must be completed first
  dripDays    Int? // Unlock after X days from enrollment
  updatedAt   DateTime @default(now())

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([state])
}

model SupportTicket {
  id          String    @id @default(uuid())
  userId      String
  lessonId    String?
  subject     String
  message     String
  status      String    @default("open") // open, in_progress, resolved, closed
  response    String?
  respondedAt DateTime?
  createdAt   DateTime  @default(now())

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson? @relation(fields: [lessonId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([userId])
  @@index([lessonId])
}

model UserActivity {
  id        String   @id @default(uuid())
  userId    String
  action    String // login, lesson_view, lesson_complete, purchase, etc.
  metadata  Json? // Additional data
  device    String? // mobile, desktop
  country   String?
  timezone  String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model PathAnalytics {
  id                 String    @id @default(uuid())
  path               String // PATH1, PATH2, etc.
  userId             String
  startedAt          DateTime  @default(now())
  completedAt        DateTime?
  revenueGenerated   Int       @default(0) // In cents
  timeToMonetization Int? // Days to first revenue
  createdAt          DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([path])
  @@index([userId])
}

model QuizConfig {
  id        String   @id @default(uuid())
  key       String   @unique // e.g., "tier_definitions", "final_screen_settings"
  value     Json // Configuration data
  updatedAt DateTime @default(now())
  updatedBy String? // Admin user ID

  @@index([key])
}
